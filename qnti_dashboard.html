<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Nexus Trading Intelligence (QNTI) Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .dashboard-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
            margin-left: 2rem;
        }
        
        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-link:hover {
            background: rgba(100, 116, 139, 0.2);
            color: #f1f5f9;
        }
        
        .nav-link.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicators {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 1.5rem;
            grid-template-areas: 
                "overview trades vision"
                "ea-control ea-performance charts"
                "logs alerts analytics";
        }

        .dashboard-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #475569;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .overview { grid-area: overview; }
        .trades { grid-area: trades; }
        .vision { grid-area: vision; }
        .ea-control { grid-area: ea-control; }
        .ea-performance { grid-area: ea-performance; }
        .charts { grid-area: charts; }
        .logs { grid-area: logs; }
        .alerts { grid-area: alerts; }
        .analytics { grid-area: analytics; }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            border: 1px solid #475569;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #64748b; }

        .trade-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .trade-item.buy { border-left-color: #10b981; }
        .trade-item.sell { border-left-color: #ef4444; }

        .trade-symbol {
            font-weight: 600;
            color: #f1f5f9;
        }

        .trade-pnl {
            font-weight: 600;
        }

        .ea-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .ea-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 6px;
            border: 1px solid #475569;
        }

        .ea-info {
            flex: 1;
        }

        .ea-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .ea-stats {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .ea-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .vision-analysis {
            margin-top: 1rem;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 6px;
        }

        .analysis-symbol {
            font-weight: 600;
        }

        .analysis-signal {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-buy {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .signal-sell {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .signal-wait {
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
            border: 1px solid #64748b;
        }

        .confidence-bar {
            width: 100%;
            height: 4px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 1rem;
        }

        .log-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .log-entry {
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .log-info { background: rgba(59, 130, 246, 0.1); }
        .log-warning { background: rgba(245, 158, 11, 0.1); }
        .log-error { background: rgba(239, 68, 68, 0.1); }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 3px solid;
        }

        .alert-critical {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: #f59e0b;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
        }

        .emergency-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #475569;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 2rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .status-good {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
        }

        .status-bad {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
                grid-template-areas: 
                    "overview trades"
                    "vision ea-control"
                    "ea-performance charts"
                    "logs alerts"
                    "analytics analytics";
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                grid-template-areas: 
                    "overview"
                    "trades"
                    "vision"
                    "ea-control"
                    "ea-performance"
                    "charts"
                    "logs"
                    "alerts"
                    "analytics";
            }
            
            .ea-controls {
                flex-direction: column;
            }
            
            .emergency-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <div class="logo">Quantum Nexus Trading Intelligence</div>
                <nav class="nav-menu">
                    <a href="/" class="nav-link active">
                        <span>ðŸ“Š</span>
                        <span>Overview</span>
                    </a>
                    <a href="/dashboard/trading_center.html" class="nav-link">
                        <span>ðŸ’¹</span>
                        <span>Trading Center</span>
                    </a>
                    <a href="/dashboard/ea_management.html" class="nav-link">
                        <span>ðŸ¤–</span>
                        <span>EA Management</span>
                    </a>
                    <a href="/dashboard/analytics_reports.html" class="nav-link">
                        <span>ðŸ“ˆ</span>
                        <span>Analytics</span>
                    </a>
                </nav>
            </div>
            <div class="status-indicators">
                <div class="status-item">
                    <span>MT5:</span>
                    <div class="status-dot status-error" id="mt5-status"></div>
                </div>
                <div class="status-item">
                    <span>Vision AI:</span>
                    <div class="status-dot status-error" id="vision-status"></div>
                </div>
                <div class="status-item">
                    <span>EAs:</span>
                    <div class="status-dot status-warning" id="ea-status"></div>
                </div>
                <div style="margin-left: 1rem; font-size: 0.9rem; color: #94a3b8;">
                    Last Update: <span id="last-update">--:--:--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- System Overview -->
        <div class="dashboard-card overview">
            <div class="card-header">
                <h3 class="card-title">System Overview</h3>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value neutral" id="total-profit">$0.00</div>
                    <div class="metric-label">Total P&L</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value neutral" id="open-trades">0</div>
                    <div class="metric-label">Open Trades</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value neutral" id="active-eas">0</div>
                    <div class="metric-label">Active EAs</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value neutral" id="win-rate">0%</div>
                    <div class="metric-label">Win Rate</div>
                </div>
            </div>
            <div class="emergency-controls">
                <button class="btn btn-danger" onclick="emergencyCloseAll()">Emergency Close All</button>
                <button class="btn btn-warning" onclick="pauseAllEAs()">Pause All EAs</button>
            </div>
        </div>

        <!-- Active Trades -->
        <div class="dashboard-card trades">
            <div class="card-header">
                <h3 class="card-title">Active Trades</h3>
                <button class="btn btn-secondary" onclick="openTradeModal()">Manual Trade</button>
            </div>
            <div class="trade-list" id="trades-list">
                <div class="loading">Loading trades...</div>
            </div>
        </div>

        <!-- Vision Analysis -->
        <div class="dashboard-card vision">
            <div class="card-header">
                <h3 class="card-title">Vision Analysis</h3>
                <button class="btn btn-primary" onclick="captureAnalysis()">Analyze Now</button>
            </div>
            <div id="vision-status-indicator" class="connection-status status-bad" style="margin-bottom: 1rem;">
                Vision AI: Not Connected
            </div>
            <div class="vision-analysis" id="vision-analysis">
                <div class="loading">No recent analysis</div>
            </div>
        </div>

        <!-- EA Control -->
        <div class="dashboard-card ea-control">
            <div class="card-header">
                <h3 class="card-title">EA Control</h3>
                <button class="btn btn-success" onclick="addEAModal()">Add EA</button>
            </div>
            <div class="ea-grid" id="ea-control-list">
                <div class="loading">Loading EAs...</div>
            </div>
        </div>

        <!-- EA Performance -->
        <div class="dashboard-card ea-performance">
            <div class="card-header">
                <h3 class="card-title">EA Performance</h3>
                <select id="performance-period" onchange="updatePerformanceChart()">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="performance-chart"></canvas>
            </div>
        </div>

        <!-- Analytics Charts -->
        <div class="dashboard-card charts">
            <div class="card-header">
                <h3 class="card-title">Equity Curve</h3>
                <div>
                    <button class="btn btn-secondary" onclick="switchChart('equity')">Equity</button>
                    <button class="btn btn-secondary" onclick="switchChart('drawdown')">Drawdown</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="main-chart"></canvas>
            </div>
        </div>

        <!-- System Logs -->
        <div class="dashboard-card logs">
            <div class="card-header">
                <h3 class="card-title">System Logs</h3>
                <button class="btn btn-secondary" onclick="clearLogs()">Clear</button>
            </div>
            <div class="log-container" id="log-container">
                <div class="loading">Loading logs...</div>
            </div>
        </div>

        <!-- Alerts & Notifications -->
        <div class="dashboard-card alerts">
            <div class="card-header">
                <h3 class="card-title">Alerts & Notifications</h3>
                <button class="btn btn-secondary" onclick="clearAlerts()">Clear All</button>
            </div>
            <div id="alerts-container">
                <div class="loading">No alerts</div>
            </div>
        </div>

        <!-- Advanced Analytics -->
        <div class="dashboard-card analytics">
            <div class="card-header">
                <h3 class="card-title">Advanced Analytics</h3>
                <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value neutral" id="sharpe-ratio">0.00</div>
                    <div class="metric-label">Sharpe Ratio</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value neutral" id="max-drawdown">0%</div>
                    <div class="metric-label">Max Drawdown</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value neutral" id="profit-factor">0.00</div>
                    <div class="metric-label">Profit Factor</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value neutral" id="recovery-factor">0.00</div>
                    <div class="metric-label">Recovery Factor</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Manual Trading -->
    <div id="trade-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; border: 1px solid #334155; min-width: 400px; max-width: 90vw;">
            <h3 style="margin-bottom: 1rem; color: #f1f5f9;">Manual Trade Entry</h3>
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8;">Symbol</label>
                    <input type="text" id="manual-symbol" placeholder="EURUSD" style="width: 100%; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8;">Type</label>
                    <select id="manual-type" style="width: 100%; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9;">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                        <option value="BUY_LIMIT">BUY LIMIT</option>
                        <option value="SELL_LIMIT">SELL LIMIT</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8;">Lot Size</label>
                    <input type="number" id="manual-lotsize" value="0.1" step="0.01" style="width: 100%; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8;">Entry Price</label>
                    <input type="number" id="manual-price" step="0.00001" style="width: 100%; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8;">Stop Loss</label>
                    <input type="number" id="manual-sl" step="0.00001" style="width: 100%; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #94a3b8;">Take Profit</label>
                    <input type="number" id="manual-tp" step="0.00001" style="width: 100%; padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9;">
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-success" onclick="submitManualTrade()">Execute Trade</button>
                    <button class="btn btn-secondary" onclick="closeTradeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let dashboardData = {
            systemHealth: {},
            trades: [],
            eas: [],
            visionAnalyses: [],
            logs: [],
            alerts: []
        };

        let charts = {
            performance: null,
            main: null
        };

        let socket = null;
        let connectionRetryCount = 0;
        const maxRetries = 5;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeWebSocket();
            loadInitialData();
            startAutoRefresh();
        });

        // Initialize WebSocket connection
        function initializeWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', function() {
                    console.log('Connected to server');
                    connectionRetryCount = 0;
                    addAlert('info', 'Connected to QNTI server');
                });

                socket.on('disconnect', function() {
                    console.log('Disconnected from server');
                    addAlert('warning', 'Disconnected from server');
                });

                socket.on('initial_data', function(data) {
                    dashboardData = data;
                    updateDashboard();
                });

                socket.on('dashboard_update', function(data) {
                    dashboardData = data;
                    updateDashboard();
                });

                socket.on('trade_update', function(data) {
                    addAlert('info', `Trade ${data.action}: ${data.symbol || 'Unknown'}`);
                    refreshData();
                });

                socket.on('ea_update', function(data) {
                    addAlert('info', `EA ${data.ea_name}: ${data.action}`);
                    refreshData();
                });

                socket.on('vision_update', function(data) {
                    addAlert('info', `Vision signal: ${data.symbol} ${data.signal} (${(data.confidence * 100).toFixed(0)}%)`);
                    refreshData();
                });

                socket.on('system_alert', function(data) {
                    addAlert(data.level, data.message);
                });

                socket.on('health_update', function(data) {
                    updateSystemHealth(data);
                });

            } catch (error) {
                console.error('WebSocket initialization error:', error);
                addAlert('error', 'Failed to initialize WebSocket connection');
            }
        }

        // Initialize Chart.js charts
        function initializeCharts() {
            // Performance Chart
            const performanceCtx = document.getElementById('performance-chart').getContext('2d');
            charts.performance = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'EA Performance',
                        data: [],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });

            // Main Chart (Equity/Drawdown)
            const mainCtx = document.getElementById('main-chart').getContext('2d');
            charts.main = new Chart(mainCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Equity',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        // Load initial data
        function loadInitialData() {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    dashboardData.systemHealth = data;
                    updateDashboard();
                })
                .catch(error => {
                    console.error('Error loading initial data:', error);
                    addAlert('error', 'Failed to load initial data');
                });
        }

        // Update entire dashboard
        function updateDashboard() {
            updateSystemOverview();
            updateTradesList();
            updateEAControl();
            updateVisionAnalysis();
            updateCharts();
            updateLogs();
            updateAlerts();
            updateTimestamp();
            updateStatusIndicators();
        }

        // Update system overview metrics
        function updateSystemOverview() {
            const health = dashboardData.systemHealth;
            if (!health) return;
            
            console.log('ðŸ“Š Updating system overview with:', health);
            
            // Total Profit/Loss
            const totalProfit = health.total_profit || 0;
            const profitElement = document.getElementById('total-profit');
            if (profitElement) {
                profitElement.textContent = `$${totalProfit.toFixed(2)}`;
                profitElement.className = `metric-value ${totalProfit >= 0 ? 'positive' : 'negative'}`;
            }
            
            // Open Trades
            const openTradesElement = document.getElementById('open-trades');
            if (openTradesElement) {
                openTradesElement.textContent = health.open_trades || 0;
            }
            
            // Active EAs
            const activeEAsElement = document.getElementById('active-eas');
            if (activeEAsElement) {
                activeEAsElement.textContent = health.active_eas || 0;
            }
            
            // Calculate win rate from trades if available
            let winRate = 0;
            if (dashboardData.trades && dashboardData.trades.length > 0) {
                const closedTrades = dashboardData.trades.filter(t => t.status === 'closed');
                const winningTrades = closedTrades.filter(t => (t.profit || 0) > 0);
                winRate = closedTrades.length > 0 ? (winningTrades.length / closedTrades.length) * 100 : 0;
            }
            const winRateElement = document.getElementById('win-rate');
            if (winRateElement) {
                winRateElement.textContent = `${winRate.toFixed(1)}%`;
            }
            
            // Update additional account info if elements exist
            const balanceElement = document.getElementById('account-balance');
            if (balanceElement && health.balance) {
                balanceElement.textContent = `$${health.balance.toFixed(2)}`;
            }
            
            const equityElement = document.getElementById('account-equity');
            if (equityElement && health.equity) {
                equityElement.textContent = `$${health.equity.toFixed(2)}`;
            }
            
            const marginElement = document.getElementById('account-margin');
            if (marginElement && health.margin) {
                marginElement.textContent = `$${health.margin.toFixed(2)}`;
            }
        }

        // Update status indicators
        function updateStatusIndicators() {
            const health = dashboardData.systemHealth;
            
            // MT5 Status
            const mt5Status = document.getElementById('mt5-status');
            if (health.mt5_status && health.mt5_status.connection_status === 'connected') {
                mt5Status.className = 'status-dot status-connected';
            } else {
                mt5Status.className = 'status-dot status-error';
            }
            
            // Vision Status
            const visionStatus = document.getElementById('vision-status');
            const visionIndicator = document.getElementById('vision-status-indicator');
            if (health.vision_status && !health.vision_status.error) {
                visionStatus.className = 'status-dot status-connected';
                visionIndicator.className = 'connection-status status-good';
                visionIndicator.textContent = 'Vision AI: Connected';
            } else {
                visionStatus.className = 'status-dot status-error';
                visionIndicator.className = 'connection-status status-bad';
                visionIndicator.textContent = 'Vision AI: Not Connected';
            }
            
            // EA Status
            const eaStatus = document.getElementById('ea-status');
            const activeEAs = health.active_eas || 0;
            if (activeEAs > 0) {
                eaStatus.className = 'status-dot status-connected';
            } else {
                eaStatus.className = 'status-dot status-warning';
            }
        }

        // Update trades list
        function updateTradesList() {
            const container = document.getElementById('trades-list');
            
            if (!dashboardData.trades || dashboardData.trades.length === 0) {
                container.innerHTML = '<div class="loading">No open trades</div>';
                return;
            }

            // Filter for open trades only
            const openTrades = dashboardData.trades.filter(trade => trade.status === 'open');
            
            if (openTrades.length === 0) {
                container.innerHTML = '<div class="loading">No open trades</div>';
                return;
            }

            container.innerHTML = openTrades.map(trade => `
                <div class="trade-item ${trade.type.toLowerCase()}">
                    <div>
                        <div class="trade-symbol">${trade.symbol}</div>
                        <div style="font-size: 0.8rem; color: #94a3b8;">${trade.type} ${trade.size}</div>
                        <div style="font-size: 0.7rem; color: #64748b;">${trade.source}</div>
                    </div>
                    <div>
                        <div class="trade-pnl ${(trade.profit || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(trade.profit || 0).toFixed(2)}
                        </div>
                        <button class="btn btn-danger" onclick="closeTrade('${trade.id}')" style="margin-top: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                            Close
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update EA control panel
        function updateEAControl() {
            const container = document.getElementById('ea-control-list');
            
            if (!dashboardData.eas || dashboardData.eas.length === 0) {
                container.innerHTML = '<div class="loading">No EAs registered</div>';
                return;
            }

            container.innerHTML = dashboardData.eas.map(ea => `
                <div class="ea-item">
                    <div class="ea-info">
                        <div class="ea-name">${ea.name}</div>
                        <div class="ea-stats">
                            P&L: ${ea.profit.toFixed(2)} | Trades: ${ea.trades} | WR: ${ea.win_rate.toFixed(1)}%
                        </div>
                        <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">
                            Status: ${ea.status} | Risk: ${ea.risk_score.toFixed(1)}
                        </div>
                    </div>
                    <div class="ea-controls">
                        ${ea.status === 'active' ? 
                            `<button class="btn btn-warning" onclick="pauseEA('${ea.name}')">Pause</button>` :
                            `<button class="btn btn-success" onclick="resumeEA('${ea.name}')">Resume</button>`
                        }
                        <button class="btn btn-danger" onclick="blockEA('${ea.name}')">Block</button>
                    </div>
                </div>
            `).join('');
        }

        // Update vision analysis
        function updateVisionAnalysis() {
            const container = document.getElementById('vision-analysis');
            
            if (!dashboardData.visionAnalyses || dashboardData.visionAnalyses.length === 0) {
                container.innerHTML = '<div class="loading">No recent analysis</div>';
                return;
            }

            container.innerHTML = dashboardData.visionAnalyses.map(analysis => `
                <div class="analysis-item">
                    <div>
                        <div class="analysis-symbol">${analysis.symbol}</div>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem;">
                            ${new Date(analysis.timestamp).toLocaleTimeString()}
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${(analysis.confidence * 100)}%"></div>
                        </div>
                    </div>
                    <div class="analysis-signal signal-${analysis.signal.toLowerCase()}">${analysis.signal}</div>
                </div>
            `).join('');
        }

        // Update charts
        function updateCharts() {
            // Update performance chart
            if (dashboardData.eas && charts.performance) {
                const labels = dashboardData.eas.map(ea => ea.name);
                const data = dashboardData.eas.map(ea => ea.profit);
                
                charts.performance.data.labels = labels;
                charts.performance.data.datasets[0].data = data;
                charts.performance.update('none'); // No animation for better performance
            }

            // Update equity chart (simulated data)
            if (charts.main) {
                const equityData = generateEquityCurve();
                charts.main.data.labels = equityData.labels;
                charts.main.data.datasets[0].data = equityData.data;
                charts.main.update('none');
            }
        }

        // Generate equity curve data from real trade history
        function generateEquityCurve() {
            const labels = [];
            const data = [];
            
            // Use real trade history if available
            if (dashboardData.tradeHistory && dashboardData.tradeHistory.length > 0) {
                dashboardData.tradeHistory.forEach(point => {
                    labels.push(new Date(point.timestamp).toLocaleDateString());
                    data.push(point.equity || point.balance || 10000);
                });
                
                console.log('ðŸ“ˆ Using real equity data:', data.length, 'points');
                return { labels, data };
            }
            
            // Fallback to simulated data if no real data available
            let equity = dashboardData.systemHealth?.balance || 10000;
            
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                labels.push(date.toLocaleDateString());
                
                // Simulate equity changes based on system performance
                const totalProfit = dashboardData.systemHealth?.total_profit || 0;
                const change = (Math.random() - 0.45) * 50 + (totalProfit / 30);
                equity += change;
                data.push(Math.max(equity, 0)); // Ensure equity doesn't go negative
            }
            
            return { labels, data };
        }

        // Update logs
        function updateLogs() {
            const container = document.getElementById('log-container');
            
            // Generate some log entries based on system activity
            const logs = [];
            
            if (dashboardData.systemHealth) {
                logs.push({
                    level: 'info',
                    message: `System running - ${dashboardData.systemHealth.open_trades || 0} open trades`,
                    timestamp: new Date()
                });
            }
            
            if (dashboardData.eas && dashboardData.eas.length > 0) {
                logs.push({
                    level: 'info',
                    message: `${dashboardData.eas.length} EAs registered and monitored`,
                    timestamp: new Date()
                });
            }
            
            if (dashboardData.visionAnalyses && dashboardData.visionAnalyses.length > 0) {
                const lastAnalysis = dashboardData.visionAnalyses[0];
                logs.push({
                    level: 'info',
                    message: `Latest vision analysis: ${lastAnalysis.symbol} ${lastAnalysis.signal}`,
                    timestamp: new Date(lastAnalysis.timestamp)
                });
            }

            if (logs.length === 0) {
                container.innerHTML = '<div class="loading">No recent logs</div>';
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-entry log-${log.level}">
                    [${log.timestamp.toLocaleTimeString()}] ${log.message}
                </div>
            `).join('');
        }

        // Update alerts
        function updateAlerts() {
            // Alerts are managed dynamically by addAlert function
            // This function can be used to clean up old alerts
            const container = document.getElementById('alerts-container');
            const alerts = container.querySelectorAll('.alert-item');
            
            // Remove alerts older than 5 minutes
            alerts.forEach(alert => {
                const timestamp = alert.dataset.timestamp;
                if (timestamp && Date.now() - parseInt(timestamp) > 300000) {
                    alert.remove();
                }
            });
        }

        // Update timestamp
        function updateTimestamp() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Auto refresh data
        function startAutoRefresh() {
            setInterval(() => {
                refreshData();
            }, 10000); // Refresh every 10 seconds
        }

        // Refresh all data
        function refreshData() {
            console.log('ðŸ”„ Refreshing dashboard data...');
            
            // Fetch system health
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    console.log('ðŸ’Š Health data received:', data);
                    // Map the API response to dashboard data structure
                    dashboardData.systemHealth = {
                        total_profit: data.account?.profit || 0,
                        open_trades: data.statistics?.active_trades || 0,
                        active_eas: data.statistics?.total_eas || 0,
                        mt5_status: {
                            connection_status: data.mt5_connection ? 'connected' : 'disconnected'
                        },
                        vision_status: {
                            error: false // Assume vision is working
                        },
                        balance: data.account?.balance || 0,
                        equity: data.account?.equity || 0,
                        margin: data.account?.margin || 0,
                        uptime: data.uptime || 0
                    };
                })
                .catch(error => console.error('âŒ Error refreshing health data:', error));
            
            // Fetch trades
            fetch('/api/trades')
                .then(response => response.json())
                .then(data => {
                    console.log('ðŸ“Š Trades data received:', data);
                    // Ensure trades is an array
                    dashboardData.trades = Array.isArray(data) ? data : [];
                })
                .catch(error => console.error('âŒ Error refreshing trades:', error));
            
            // Fetch EAs
            fetch('/api/eas')
                .then(response => response.json())
                .then(data => {
                    console.log('ðŸ¤– EAs data received:', data);
                    // Ensure EAs is an array and map to expected format
                    const easArray = Array.isArray(data) ? data : [];
                    dashboardData.eas = easArray.map(ea => ({
                        name: ea.name || 'Unknown EA',
                        profit: ea.total_profit || 0,
                        trades: ea.total_trades || 0,
                        win_rate: ea.win_rate || 0,
                        status: ea.status || 'unknown',
                        risk_score: ea.risk_score || 0,
                        magic_number: ea.magic_number || 0
                    }));
                    
                    // Fetch trade history for equity curve
                    fetch('/api/trades/history?timeframe=1M')
                        .then(response => response.json())
                        .then(historyData => {
                            console.log('ðŸ“ˆ Trade history received:', historyData);
                            dashboardData.tradeHistory = historyData;
                            updateDashboard();
                        })
                        .catch(error => {
                            console.error('âŒ Error refreshing trade history:', error);
                            updateDashboard();
                        });
                })
                .catch(error => {
                    console.error('âŒ Error refreshing EAs:', error);
                    updateDashboard();
                });
        }

        // EA Control Functions
        function pauseEA(eaName) {
            fetch(`/api/eas/${eaName}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'pause' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addAlert('info', `EA ${eaName} paused successfully`);
                    refreshData();
                } else {
                    addAlert('error', `Failed to pause EA ${eaName}: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error pausing EA:', error);
                addAlert('error', `Error pausing EA ${eaName}`);
            });
        }

        function resumeEA(eaName) {
            fetch(`/api/eas/${eaName}/control`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'resume' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addAlert('info', `EA ${eaName} resumed successfully`);
                    refreshData();
                } else {
                    addAlert('error', `Failed to resume EA ${eaName}: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error resuming EA:', error);
                addAlert('error', `Error resuming EA ${eaName}`);
            });
        }

        function blockEA(eaName) {
            if (confirm(`Are you sure you want to block EA ${eaName}? This will prevent it from opening new trades.`)) {
                fetch(`/api/eas/${eaName}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'block' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addAlert('warning', `EA ${eaName} blocked successfully`);
                        refreshData();
                    } else {
                        addAlert('error', `Failed to block EA ${eaName}: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error blocking EA:', error);
                    addAlert('error', `Error blocking EA ${eaName}`);
                });
            }
        }

        function pauseAllEAs() {
            if (confirm('Are you sure you want to pause ALL EAs?')) {
                dashboardData.eas.forEach(ea => {
                    if (ea.status === 'active') {
                        pauseEA(ea.name);
                    }
                });
            }
        }

        // Trade Functions
        function closeTrade(tradeId) {
            if (confirm(`Are you sure you want to close trade ${tradeId}?`)) {
                fetch(`/api/trades/${tradeId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addAlert('info', `Trade ${tradeId} closed successfully`);
                        refreshData();
                    } else {
                        addAlert('error', `Failed to close trade ${tradeId}: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error closing trade:', error);
                    addAlert('error', `Error closing trade ${tradeId}`);
                });
            }
        }

        function emergencyCloseAll() {
            if (confirm('EMERGENCY: Are you sure you want to close ALL open trades? This action cannot be undone!')) {
                fetch('/api/system/emergency-stop', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addAlert('critical', 'EMERGENCY STOP EXECUTED: All trades closed');
                        refreshData();
                    } else {
                        addAlert('error', `Emergency stop failed: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error executing emergency stop:', error);
                    addAlert('error', 'Error executing emergency stop');
                });
            }
        }

        // Manual Trading Modal
        function openTradeModal() {
            document.getElementById('trade-modal').style.display = 'block';
        }

        function closeTradeModal() {
            document.getElementById('trade-modal').style.display = 'none';
        }

        function submitManualTrade() {
            const symbol = document.getElementById('manual-symbol').value;
            const type = document.getElementById('manual-type').value;
            const lotSize = parseFloat(document.getElementById('manual-lotsize').value);
            const price = parseFloat(document.getElementById('manual-price').value);
            const sl = parseFloat(document.getElementById('manual-sl').value);
            const tp = parseFloat(document.getElementById('manual-tp').value);

            if (!symbol || !lotSize || !price) {
                alert('Please fill in Symbol, Lot Size, and Entry Price');
                return;
            }

            const tradeData = {
                symbol: symbol.toUpperCase(),
                type: type,
                lot_size: lotSize,
                price: price,
                stop_loss: sl || null,
                take_profit: tp || null,
                notes: 'Manual trade from dashboard'
            };

            fetch('/api/trades', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tradeData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addAlert('info', `Manual trade executed: ${type} ${lotSize} ${symbol}`);
                    closeTradeModal();
                    refreshData();
                } else {
                    addAlert('error', `Trade execution failed: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error executing manual trade:', error);
                addAlert('error', 'Error executing manual trade');
            });
        }

        // Vision Analysis Functions
        function captureAnalysis() {
            addAlert('info', 'Initiating chart analysis...');
            
            fetch('/api/vision/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol: 'EURUSD', timeframe: 'H1' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addAlert('info', 'Chart analysis started successfully');
                } else {
                    addAlert('error', `Analysis failed: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error starting analysis:', error);
                addAlert('error', 'Error starting chart analysis');
            });
        }

        // Chart Functions
        function switchChart(chartType) {
            if (chartType === 'drawdown') {
                charts.main.data.datasets[0].label = 'Drawdown';
                charts.main.data.datasets[0].borderColor = '#ef4444';
                charts.main.data.datasets[0].backgroundColor = 'rgba(239, 68, 68, 0.1)';
                
                // Generate drawdown data
                const drawdownData = Array.from({length: 30}, () => Math.random() * -15);
                charts.main.data.datasets[0].data = drawdownData;
            } else {
                charts.main.data.datasets[0].label = 'Equity';
                charts.main.data.datasets[0].borderColor = '#10b981';
                charts.main.data.datasets[0].backgroundColor = 'rgba(16, 185, 129, 0.1)';
                
                // Generate equity data
                const equityData = generateEquityCurve();
                charts.main.data.datasets[0].data = equityData.data;
            }
            
            charts.main.update();
        }

        function updatePerformanceChart() {
            const period = document.getElementById('performance-period').value;
            // In a real implementation, this would fetch data for the selected period
            updateCharts();
        }

        // Utility Functions
        function addAlert(type, message) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertElement = document.createElement('div');
            alertElement.className = `alert-item alert-${type}`;
            alertElement.dataset.timestamp = Date.now().toString();
            alertElement.innerHTML = `
                <div>
                    <strong>${type.toUpperCase()}:</strong> ${message}
                    <div style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">
                        ${new Date().toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            alertsContainer.insertBefore(alertElement, alertsContainer.firstChild);
            
            // Remove old alerts (keep max 10)
            const alerts = alertsContainer.querySelectorAll('.alert-item');
            if (alerts.length > 10) {
                alerts[alerts.length - 1].remove();
            }
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '<div class="loading">Logs cleared</div>';
        }

        function clearAlerts() {
            document.getElementById('alerts-container').innerHTML = '<div class="loading">No alerts</div>';
        }

        function generateReport() {
            addAlert('info', 'Generating advanced analytics report...');
            
            // Simulate report generation
            setTimeout(() => {
                // Update analytics metrics with calculated data
                const totalProfit = dashboardData.systemHealth.total_profit || 0;
                const totalTrades = dashboardData.trades ? dashboardData.trades.length : 0;
                
                document.getElementById('sharpe-ratio').textContent = (1.2 + Math.random() * 0.8).toFixed(2);
                document.getElementById('max-drawdown').textContent = (5 + Math.random() * 10).toFixed(1) + '%';
                document.getElementById('profit-factor').textContent = (Math.max(totalProfit / 1000, 0.5) + Math.random() * 1.0).toFixed(2);
                document.getElementById('recovery-factor').textContent = (2.0 + Math.random() * 2.0).toFixed(2);
                
                addAlert('info', 'Advanced analytics report generated successfully');
            }, 2000);
        }

        function addEAModal() {
            // Placeholder for EA addition functionality
            alert('EA Addition feature - Coming soon!\n\nThis will allow you to register new Expert Advisors for monitoring.');
        }

        // Error handling
        window.addEventListener('error', function(event) {
            console.error('Dashboard error:', event.error);
            addAlert('error', `System error: ${event.error.message}`);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch(event.key) {
                    case 'r':
                        event.preventDefault();
                        refreshData();
                        break;
                    case 't':
                        event.preventDefault();
                        openTradeModal();
                        break;
                    case 'a':
                        event.preventDefault();
                        captureAnalysis();
                        break;
                    case 'e':
                        event.preventDefault();
                        if (confirm('Emergency close all trades?')) {
                            emergencyCloseAll();
                        }
                        break;
                }
            }
        });

        // Mobile responsiveness handlers
        function handleResize() {
            if (charts.performance) charts.performance.resize();
            if (charts.main) charts.main.resize();
        }

        window.addEventListener('resize', handleResize);

        // Update system health specifically
        function updateSystemHealth(healthData) {
            dashboardData.systemHealth = healthData;
            updateSystemOverview();
            updateStatusIndicators();
        }

        // Connection retry logic
        function retryConnection() {
            if (connectionRetryCount < maxRetries) {
                connectionRetryCount++;
                setTimeout(() => {
                    console.log(`Retrying connection... Attempt ${connectionRetryCount}`);
                    initializeWebSocket();
                }, connectionRetryCount * 2000);
            } else {
                addAlert('error', 'Maximum connection retries reached. Please refresh the page.');
            }
        }

        // Initialize tooltips
        function initializeTooltips() {
            const tooltips = {
                'total-profit': 'Total profit/loss across all trades and EAs',
                'open-trades': 'Number of currently open positions',
                'active-eas': 'Number of Expert Advisors currently running',
                'win-rate': 'Percentage of profitable closed trades'
            };

            Object.entries(tooltips).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = text;
                }
            });
        }

        // Call initialization functions
        setTimeout(initializeTooltips, 1000);
        
        console.log('QNTI Dashboard initialized successfully');
    </script>
</body>
</html>