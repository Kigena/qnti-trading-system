<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QNTI Analytics & Reports</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .dashboard-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover {
            background: rgba(100, 116, 139, 0.2);
            color: #f1f5f9;
        }

        .nav-link.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #475569;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-info { background: #8b5cf6; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid #3b82f6;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }

        .report-section {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .report-title {
            font-weight: 600;
            color: #f1f5f9;
        }

        .report-date {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .performance-table th,
        .performance-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #475569;
        }

        .performance-table th {
            background: rgba(51, 65, 85, 0.5);
            color: #f1f5f9;
            font-weight: 600;
        }

        .performance-table td {
            color: #e2e8f0;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-controls select,
        .filter-controls input {
            padding: 0.5rem;
            border: 1px solid #475569;
            border-radius: 4px;
            background: #334155;
            color: #f1f5f9;
        }

        .top-performers-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .performer-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .performer-item .rank {
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
            min-width: 3rem;
        }

        .performer-item .ea-info {
            flex: 1;
            margin-left: 1rem;
        }

        .performer-item .ea-name {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .performer-item .ea-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .performer-item .profit.positive {
            color: #10b981;
        }

        .performer-item .profit.negative {
            color: #ef4444;
        }

        .performer-item .win-rate {
            color: #94a3b8;
        }

        .performer-item .trades {
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-content">
            <div class="logo">Quantum Nexus Trading Intelligence</div>
            <nav class="nav-menu">
                <a href="/" class="nav-link">
                    <span>üìä</span>
                    <span>Overview</span>
                </a>
                <a href="/dashboard/trading_center.html" class="nav-link">
                    <span>üíπ</span>
                    <span>Trading Center</span>
                </a>
                <a href="/dashboard/ea_management.html" class="nav-link">
                    <span>ü§ñ</span>
                    <span>EA Management</span>
                </a>
                <a href="/dashboard/analytics_reports.html" class="nav-link active">
                    <span>üìà</span>
                    <span>Analytics</span>
                </a>
            </nav>
            <div class="status-indicators">
                <button class="btn btn-primary" onclick="generateReport()">üìÑ Generate Report</button>
                <button class="btn btn-info" onclick="exportData()">üíæ Export Data</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator & Error Message for Redis Cache Integration -->
    <div id="loading-indicator" style="display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(59, 130, 246, 0.9); color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
        Loading...
    </div>
    
    <div id="error-message" style="display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.9); color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
        Error message
    </div>

    <div class="main-container">
        <!-- Filter Controls -->
        <div class="filter-controls">
            <label style="color: #94a3b8;">Time Period:</label>
            <select onchange="updateTimeframe(this.value)">
                <option value="1D">Today</option>
                <option value="1W">This Week</option>
                <option value="1M" selected>This Month</option>
                <option value="3M">3 Months</option>
                <option value="6M">6 Months</option>
                <option value="1Y">1 Year</option>
                <option value="ALL">All Time</option>
            </select>
            
            <label style="color: #94a3b8;">EA Filter:</label>
            <select onchange="filterByEA(this.value)">
                <option value="all">All EAs</option>
                <option value="TrendMaster">TrendMaster Pro</option>
                <option value="ScalperX">Scalper X</option>
                <option value="GridTrader">Grid Trader</option>
            </select>
            
            <label style="color: #94a3b8;">Symbol:</label>
            <select onchange="filterBySymbol(this.value)">
                <option value="all">All Symbols</option>
                <option value="EURUSD">EURUSD</option>
                <option value="GBPUSD">GBPUSD</option>
                <option value="USDJPY">USDJPY</option>
                <option value="AUDUSD">AUDUSD</option>
            </select>
            
            <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
        </div>

        <!-- Key Performance Metrics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div id="total-profit" class="stat-value">--</div>
                <div class="stat-label">Total Profit</div>
                <div class="stat-change positive">+12.5% vs last month</div>
            </div>
            <div class="stat-card">
                <div id="total-trades" class="stat-value">--</div>
                <div class="stat-label">Total Trades</div>
                <div class="stat-change positive">+8.2% vs last month</div>
            </div>
            <div class="stat-card">
                <div id="win-rate" class="stat-value">--</div>
                <div class="stat-label">Win Rate</div>
                <div class="stat-change positive">+2.1% vs last month</div>
            </div>
            <div class="stat-card">
                <div id="profit-factor" class="stat-value">--</div>
                <div class="stat-label">Profit Factor</div>
                <div class="stat-change negative">-0.05 vs last month</div>
            </div>
            <div class="stat-card">
                <div id="max-drawdown" class="stat-value">--</div>
                <div class="stat-label">Max Drawdown</div>
                <div class="stat-change positive">-2.3% vs last month</div>
            </div>
            <div class="stat-card">
                <div id="avg-trade" class="stat-value">--</div>
                <div class="stat-label">Avg Trade P&L</div>
                <div class="stat-change positive">+$3.20 vs last month</div>
            </div>
            <div class="stat-card">
                <div id="sharpe-ratio" class="stat-value">--</div>
                <div class="stat-label">Sharpe Ratio</div>
                <div class="stat-change positive">+0.12 vs last month</div>
            </div>
            <div class="stat-card">
                <div id="best-trade" class="stat-value">--</div>
                <div class="stat-label">Best Trade</div>
                <div class="stat-change positive">+$15.50 vs last month</div>
            </div>
            <div class="stat-card">
                <div id="worst-trade" class="stat-value">--</div>
                <div class="stat-label">Worst Trade</div>
                <div class="stat-change negative">-$8.20 vs last month</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="analytics-grid">
            <!-- Equity Curve -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">Equity Curve</h3>
                    <select onchange="updateEquityChart(this.value)" style="padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9; font-size: 0.85rem;">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="equity-chart"></canvas>
                </div>
            </div>

            <!-- Profit/Loss Distribution -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">P&L Distribution</h3>
                    <button class="btn btn-sm btn-secondary" onclick="refreshPLChart()">Refresh</button>
                </div>
                <div class="chart-container">
                    <canvas id="pl-distribution-chart"></canvas>
                </div>
            </div>

            <!-- EA Performance Comparison -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">EA Performance Comparison</h3>
                    <select onchange="updateEAChart(this.value)" style="padding: 0.5rem; border: 1px solid #475569; border-radius: 4px; background: #334155; color: #f1f5f9; font-size: 0.85rem;">
                        <option value="profit">Profit</option>
                        <option value="trades">Number of Trades</option>
                        <option value="winrate">Win Rate</option>
                        <option value="drawdown">Max Drawdown</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="ea-comparison-chart"></canvas>
                </div>
            </div>

            <!-- Symbol Performance -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title">Symbol Performance</h3>
                    <button class="btn btn-sm btn-secondary" onclick="refreshSymbolChart()">Refresh</button>
                </div>
                <div class="chart-container">
                    <canvas id="symbol-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">üèÜ Top Performing EAs</h3>
            </div>
            <div id="top-performers" class="top-performers-container">
                <div class="loading">Loading top performers...</div>
            </div>
        </div>

        <!-- Detailed Reports -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Detailed Performance Report</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-sm btn-info" onclick="downloadReport('pdf')">üìÑ PDF</button>
                    <button class="btn btn-sm btn-success" onclick="downloadReport('excel')">üìä Excel</button>
                    <button class="btn btn-sm btn-secondary" onclick="downloadReport('csv')">üìã CSV</button>
                </div>
            </div>
            
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>EA Name</th>
                        <th>Symbol</th>
                        <th>Total Trades</th>
                        <th>Win Rate</th>
                        <th>Total P&L</th>
                        <th>Profit Factor</th>
                        <th>Max DD</th>
                        <th>Avg Trade</th>
                    </tr>
                </thead>
                <tbody id="ea-performance-body">
                </tbody>
            </table>
        </div>

        <!-- AI Insights -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">ü§ñ AI Performance Insights</h3>
                <button class="btn btn-sm btn-info" onclick="generateAIInsights()">Generate New Insights</button>
            </div>
            
            <div class="report-section">
                <div class="report-header">
                    <div class="report-title">Market Trend Analysis</div>
                    <div class="report-date">Updated 2 hours ago</div>
                </div>
                <div style="color: #e2e8f0; line-height: 1.6;">
                    <p>The AI has detected a strong bullish trend in EUR/USD over the past 30 days. TrendMaster Pro is performing exceptionally well in this environment with a 68.5% win rate. Consider increasing position sizes for this EA during current market conditions.</p>
                </div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <div class="report-title">Risk Assessment</div>
                    <div class="report-date">Updated 4 hours ago</div>
                </div>
                <div style="color: #e2e8f0; line-height: 1.6;">
                    <p>Grid Trader is showing increased drawdown risk. The AI recommends reducing lot sizes or pausing this EA until market volatility decreases. Current risk score: 7.2/10 (High).</p>
                </div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <div class="report-title">Optimization Opportunities</div>
                    <div class="report-date">Updated 6 hours ago</div>
                </div>
                <div style="color: #e2e8f0; line-height: 1.6;">
                    <p>News Hunter EA could benefit from adjusted take profit levels. AI suggests increasing TP from 20 to 25 pips based on recent market behavior analysis. Expected improvement: +15% profit.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Load initial analytics data
            updateAnalyticsData();
            
            // Set up periodic updates every 30 seconds for analytics data
            setInterval(updateAnalyticsData, 30000);
            
            // Set up real-time updates via WebSocket
            if (typeof io !== 'undefined') {
                const socket = io();
                socket.on('trade_update', function(data) {
                    updateAnalyticsData();
                });
                socket.on('ea_update', function(data) {
                    updateAnalyticsData();
                });
            }
        });

        updateTimestamp();
        setInterval(updateTimestamp, 1000);

        // Initialize Equity Chart with enhanced error handling
        initializeEquityChart();

        // Initialize P&L Distribution Chart
        const plCtx = document.getElementById('pl-distribution-chart').getContext('2d');
        window.plChart = new Chart(plCtx, {
            type: 'doughnut',
            data: {
                labels: ['Winning Trades', 'Losing Trades'],
                datasets: [{
                    data: [0, 0], // Will be updated with real data
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8' }
                    }
                }
            }
        });

        // Initialize EA Comparison Chart
        const eaCtx = document.getElementById('ea-comparison-chart').getContext('2d');
        window.eaChart = new Chart(eaCtx, {
            type: 'bar',
            data: {
                labels: [], // Will be populated with real EA names
                datasets: [{
                    label: 'Profit ($)',
                    data: [], // Will be populated with real profit data
                    backgroundColor: [],
                    borderWidth: 0,
                    yAxisID: 'y'
                }, {
                    label: 'Win Rate (%)',
                    data: [], // Will be populated with real win rate data
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderWidth: 0,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        labels: { color: '#94a3b8' }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        grid: { color: 'rgba(100, 116, 139, 0.2)' },
                        ticks: { color: '#94a3b8' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        max: 100,
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#94a3b8' }
                    },
                    x: {
                        grid: { color: 'rgba(100, 116, 139, 0.2)' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });

        // Initialize Symbol Chart
        const symbolCtx = document.getElementById('symbol-chart').getContext('2d');
        window.symbolChart = new Chart(symbolCtx, {
            type: 'radar',
            data: {
                labels: [], // Will be populated with real symbols
                datasets: [{
                    label: 'Performance Score',
                    data: [], // Will be populated with real performance data
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.2)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(100, 116, 139, 0.2)' },
                        ticks: { color: '#94a3b8' },
                        pointLabels: { color: '#94a3b8' }
                    }
                }
            }
        });

        // Functions
        function updateTimeframe(period) {
            console.log(`Updating timeframe to: ${period}`);
            // Trigger data refresh with new timeframe
            updateAnalyticsData();
        }

        function filterByEA(ea) {
            console.log(`Filtering by EA: ${ea}`);
            // Implement EA filtering logic
            updateAnalyticsData();
        }

        function filterBySymbol(symbol) {
            console.log(`Filtering by symbol: ${symbol}`);
            // Implement symbol filtering logic
            updateAnalyticsData();
        }

        function resetFilters() {
            console.log('Resetting filters');
            // Reset all filters and refresh data
            updateAnalyticsData();
        }

        function generateReport() {
            console.log('Generating comprehensive report');
        }

        function exportData() {
            console.log('Exporting data');
        }

        function refreshPLChart() {
            console.log('Refreshing P&L chart');
            // Refresh P&L distribution with current data
            fetchHealthMetrics();
        }

        function updateEAChart(metric) {
            console.log(`Updating EA chart: ${metric}`);
            // Update EA chart with selected metric
            fetchEAPerformanceData();
        }

        function refreshSymbolChart() {
            console.log('Refreshing symbol chart');
            // Refresh symbol performance chart
            fetchSymbolPerformanceData();
        }

        function downloadReport(format) {
            console.log(`Downloading report in ${format} format`);
        }

        function generateAIInsights() {
            console.log('Generating AI insights');
        }

        function initializeCharts() {
            console.log('Initializing charts...');
            // Charts are already initialized above as global window objects
            // This function is here for consistency and potential future chart setup
        }

        function updateTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleString();
            console.log('Analytics page timestamp:', timestamp);
            // Update any timestamp elements if they exist
            const timestampElements = document.querySelectorAll('.last-updated');
            timestampElements.forEach(el => {
                el.textContent = `Last updated: ${timestamp}`;
            });
        }

        // === REDIS CACHE INTEGRATION & TIMEOUT HANDLING ===
        // Configuration for timeout handling and retry logic
        const API_TIMEOUT = 60000; // 60 seconds timeout for slow backend responses
        const RETRY_DELAY = 5000;   // 5 seconds between retries
        const MAX_RETRIES = 3;      // Maximum number of retry attempts
        
        // Global state management
        let isUpdating = false;
        let retryCount = 0;
        let lastUpdateTime = 0;
        
        // Enhanced fetch with timeout and retry logic
        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
            
            try {
                showLoading(`Fetching ${url}...`);
                const response = await fetch(url, { 
                    ...options, 
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                hideLoading();
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                hideLoading();
                
                if (error.name === 'AbortError') {
                    showError(`Request to ${url} timed out after ${API_TIMEOUT/1000}s`);
                    throw new Error(`Timeout: ${url}`);
                }
                throw error;
            }
        }
        
        // Enhanced loading indicator
        function showLoading(message) {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'block';
                indicator.textContent = message || 'Loading...';
            }
            console.log('‚è≥', message);
        }
        
        function hideLoading() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 10000);
            }
            console.error('‚ùå', message);
        }
        
        // Real-time analytics data updates with Redis cache optimization
        async function updateAnalyticsData() {
            if (isUpdating) {
                console.log('‚è≥ Analytics data update already in progress, skipping...');
                return;
            }
            
            isUpdating = true;
            const startTime = Date.now();
            console.log('üîÑ Starting analytics data update with Redis cache optimization...');
            
            try {
                // Fetch system health and performance metrics with timeout handling
                await fetchHealthMetrics();
                
                // Fetch trade history for analytics with timeout handling
                await fetchTradeHistory();
                
                // Fetch EA performance data with timeout handling
                await fetchEAPerformanceData();
                
                // Fetch symbol performance data with timeout handling
                await fetchSymbolPerformanceData();
                
                // Update performance metrics
                const duration = Date.now() - startTime;
                lastUpdateTime = Date.now();
                retryCount = 0; // Reset retry count on successful update
                
                console.log(`‚úÖ Analytics data update completed in ${duration}ms`);
                
            } catch (error) {
                console.error(`‚ùå Analytics data update failed after ${Date.now() - startTime}ms:`, error);
                retryCount++;
                
                if (retryCount < MAX_RETRIES) {
                    console.log(`üîÑ Retrying analytics update (${retryCount}/${MAX_RETRIES}) in ${RETRY_DELAY}ms...`);
                    setTimeout(() => {
                        isUpdating = false; // Reset flag for retry
                        updateAnalyticsData();
                    }, RETRY_DELAY);
                } else {
                    console.error('‚ùå Max retries reached for analytics data update');
                    showError('Failed to update analytics data after multiple attempts');
                    retryCount = 0; // Reset for next cycle
                }
            } finally {
                isUpdating = false;
            }
        }
        
        // Health metrics fetching with Redis cache optimization
        async function fetchHealthMetrics() {
            try {
                const response = await fetchWithTimeout('/api/health');
                const data = await response.json();
                
                console.log('üìä Health metrics received:', data);
                
                // Log Redis cache performance if available
                if (data.cache_performance) {
                    console.log('üöÄ Redis Cache Performance:', data.cache_performance);
                }
                
                updateHealthMetrics(data);
                
            } catch (error) {
                console.error('‚ùå Error fetching health metrics:', error);
                showError('Failed to fetch health metrics');
                throw error;
            }
        }
        
        // Trade history fetching with Redis cache optimization
        async function fetchTradeHistory(timeframe = '1M') {
            try {
                console.log(`üìà Fetching trade history from /api/trades/history?timeframe=${timeframe}`);
                const response = await fetchWithTimeout(`/api/trades/history?timeframe=${timeframe}`);
                const data = await response.json();
                
                console.log('üìà Trade history API response:', {
                    status: response.status,
                    timeframe: timeframe,
                    dataKeys: Object.keys(data),
                    historyLength: data.history?.length || 0,
                    tradesLength: data.trades?.length || 0,
                    historyFirstPoint: data.history?.[0],
                    historyLastPoint: data.history?.[data.history?.length - 1]
                });
                
                if (data.history && Array.isArray(data.history) && data.history.length > 0) {
                    console.log('üìà Calling updateEquityChart with', data.history.length, 'history points');
                    updateEquityChart(data.history);
                } else {
                    console.warn('‚ö†Ô∏è No history data available in API response');
                    updateEquityChart([]); // This will show "No Data" in the chart
                }
                
                updateTradeAnalytics(data.trades || []);
                
            } catch (error) {
                console.error('‚ùå Error fetching trade history:', error);
                showError('Failed to fetch trade history');
                throw error;
            }
        }
        
        // EA performance data fetching with Redis cache optimization
        async function fetchEAPerformanceData() {
            try {
                const response = await fetchWithTimeout('/api/eas');
                let eas = await response.json();
                if (!Array.isArray(eas)) {
                    eas = Object.values(eas);
                }
                
                console.log('ü§ñ EA performance data received:', eas);
                
                updateEAPerformanceChart(eas);
                updateTopPerformers(eas);
                updateEAPerformanceTable(eas);
                
            } catch (error) {
                console.error('‚ùå Error fetching EA performance data:', error);
                showError('Failed to fetch EA performance data');
                throw error;
            }
        }

        function updateHealthMetrics(healthData) {
            console.log('üíä Updating health metrics from data:', healthData);
            
            // Map API response structure to expected format
            const mappedData = {
                total_profit: healthData.account?.profit || 0,
                win_rate: healthData.statistics?.win_rate || 0,
                best_trade: healthData.statistics?.best_trade || 0,
                worst_trade: healthData.statistics?.worst_trade || 0,
                avg_trade: healthData.statistics?.avg_trade || 0,
                sharpe_ratio: healthData.statistics?.sharpe_ratio || 0
            };
            
            console.log('üíä Mapped health data:', mappedData);
            
            // Update the metric cards
            if (mappedData.total_profit !== undefined) {
                const totalProfitEl = document.getElementById('total-profit');
                if (totalProfitEl) totalProfitEl.textContent = `$${mappedData.total_profit.toFixed(2)}`;
            }
            
            if (mappedData.win_rate !== undefined) {
                const winRateEl = document.getElementById('win-rate');
                if (winRateEl) winRateEl.textContent = `${mappedData.win_rate.toFixed(1)}%`;
            }
            
            if (mappedData.best_trade !== undefined) {
                const bestTradeEl = document.getElementById('best-trade');
                if (bestTradeEl) bestTradeEl.textContent = `$${mappedData.best_trade.toFixed(2)}`;
            }
            
            if (mappedData.worst_trade !== undefined) {
                const worstTradeEl = document.getElementById('worst-trade');
                if (worstTradeEl) worstTradeEl.textContent = `$${mappedData.worst_trade.toFixed(2)}`;
            }
            
            if (mappedData.avg_trade !== undefined) {
                const avgTradeEl = document.getElementById('avg-trade');
                if (avgTradeEl) avgTradeEl.textContent = `$${mappedData.avg_trade.toFixed(2)}`;
            }
            
            if (mappedData.sharpe_ratio !== undefined) {
                const sharpeRatioEl = document.getElementById('sharpe-ratio');
                if (sharpeRatioEl) sharpeRatioEl.textContent = mappedData.sharpe_ratio.toFixed(2);
            }
            
            // Update P&L Distribution Chart
            updatePLDistributionChart(healthData);
        }

        function updatePLDistributionChart(healthData) {
            if (!window.plChart || !healthData) {
                console.warn('‚ùå P&L chart not available or no health data');
                return;
            }
            
            const winRate = healthData.statistics?.win_rate || 0;
            const lossRate = 100 - winRate;
            
            console.log('üìä Updating P&L distribution chart:', { winRate, lossRate });
            
            window.plChart.data.datasets[0].data = [winRate, lossRate];
            window.plChart.update();
            
            console.log('üìä P&L distribution chart updated successfully');
        }

        function updateEAPerformanceChart(eas) {
            if (!window.eaChart || !eas.length) {
                console.log('EA chart not available or no EAs:', !!window.eaChart, eas.length);
                return;
            }
            
            const topEAs = eas.slice(0, 8); // Show top 8 EAs
            const labels = topEAs.map(ea => ea.name || ea.ea_name || 'Unknown');
            const profits = topEAs.map(ea => ea.total_profit || 0);
            const winRates = topEAs.map(ea => ea.win_rate || 0);
            
            // Generate background colors based on profit (green for positive, red for negative)
            const backgroundColors = profits.map(profit => profit >= 0 ? '#10b981' : '#ef4444');
            
            console.log('ü§ñ Updating EA chart with:', { labels, profits, winRates, backgroundColors });
            
            window.eaChart.data.labels = labels;
            window.eaChart.data.datasets[0].data = profits;
            window.eaChart.data.datasets[0].backgroundColor = backgroundColors;
            if (window.eaChart.data.datasets[1]) {
                window.eaChart.data.datasets[1].data = winRates;
            }
            window.eaChart.update();
            
            console.log('ü§ñ EA performance chart updated successfully');
        }

        function updateTradeAnalytics(trades) {
            if (!trades.length) return;
            
            // Calculate trade distribution by symbol
            const symbolCounts = {};
            trades.forEach(trade => {
                symbolCounts[trade.symbol] = (symbolCounts[trade.symbol] || 0) + 1;
            });
            
            // Update symbol distribution chart
            if (window.symbolChart) {
                const symbols = Object.keys(symbolCounts).slice(0, 8);
                const counts = symbols.map(symbol => symbolCounts[symbol]);
                
                window.symbolChart.data.labels = symbols;
                window.symbolChart.data.datasets[0].data = counts;
                window.symbolChart.update();
            }
            
            // Calculate monthly performance
            const monthlyData = {};
            trades.forEach(trade => {
                if (trade.close_time) {
                    const month = new Date(trade.close_time).toISOString().slice(0, 7);
                    if (!monthlyData[month]) {
                        monthlyData[month] = { profit: 0, trades: 0 };
                    }
                    monthlyData[month].profit += trade.profit || 0;
                    monthlyData[month].trades += 1;
                }
            });
            
            // Update monthly performance chart
            if (window.monthlyChart) {
                const months = Object.keys(monthlyData).sort().slice(-12);
                const profits = months.map(month => monthlyData[month].profit);
                
                window.monthlyChart.data.labels = months;
                window.monthlyChart.data.datasets[0].data = profits;
                window.monthlyChart.update();
            }
        }

        function updateTopPerformers(eas) {
            console.log('üèÜ Updating top performers with EAs:', eas);
            
            const topEAs = eas.sort((a, b) => (b.total_profit || 0) - (a.total_profit || 0)).slice(0, 5);
            console.log('üèÜ Top 5 EAs:', topEAs);
            
            const container = document.getElementById('top-performers');
            if (!container) {
                console.warn('‚ùå Top performers container not found');
                return;
            }
            
            container.innerHTML = '';
            topEAs.forEach((ea, index) => {
                const item = document.createElement('div');
                item.className = 'performer-item';
                item.innerHTML = `
                    <div class="rank">#${index + 1}</div>
                    <div class="ea-info">
                        <div class="ea-name">${ea.name}</div>
                        <div class="ea-stats">
                            <span class="profit ${ea.total_profit >= 0 ? 'positive' : 'negative'}">$${(ea.total_profit || 0).toFixed(2)}</span>
                            <span class="win-rate">${(ea.win_rate || 0).toFixed(1)}% WR</span>
                            <span class="trades">${ea.total_trades || 0} trades</span>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateEAPerformanceTable(eas) {
            const tbody = document.getElementById('ea-performance-body');
            if (!tbody) return;

            tbody.innerHTML = '';
            eas.forEach(ea => {
                const row = document.createElement('tr');
                const totalProfit = ea.total_profit || 0;
                row.innerHTML = `
                    <td>${ea.name}</td>
                    <td>${ea.symbol || '-'}</td>
                    <td>${ea.total_trades || 0}</td>
                    <td class="${ea.win_rate >= 50 ? 'positive' : 'negative'}">${(ea.win_rate || 0).toFixed(1)}%</td>
                    <td class="${totalProfit >= 0 ? 'positive' : 'negative'}">${totalProfit >= 0 ? '+' : '-'}$${Math.abs(totalProfit).toFixed(2)}</td>
                    <td>${(ea.profit_factor || 0).toFixed(2)}</td>
                    <td class="negative">${(ea.max_drawdown || 0).toFixed(2)}%</td>
                    <td class="${(ea.avg_trade || 0) >= 0 ? 'positive' : 'negative'}">$${(ea.avg_trade || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Report generation functions
        function generateReport(type) {
            const params = new URLSearchParams({
                type: type,
                start_date: document.getElementById('start-date')?.value || '',
                end_date: document.getElementById('end-date')?.value || '',
                format: document.getElementById('report-format')?.value || 'pdf'
            });

            fetch(`/api/reports/generate?${params}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Failed to generate report');
                }
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}_report_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('Report generated successfully');
            })
            .catch(error => {
                console.error('Error generating report:', error);
                alert('Error generating report: ' + error.message);
            });
        }

        function exportData(format) {
            fetch(`/api/data/export?format=${format}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Failed to export data');
                }
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qnti_data_export_${new Date().toISOString().slice(0, 10)}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('Data exported successfully');
            })
            .catch(error => {
                console.error('Error exporting data:', error);
                alert('Error exporting data: ' + error.message);
            });
        }

        function updateTimeframe() {
            const timeframe = document.getElementById('timeframe-select').value;
            
            // Fetch data for the selected timeframe
            fetch(`/api/trades/history?timeframe=${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    updateEquityChart(data.history || []);
                    updateTradeAnalytics(data.trades || []);
                })
                .catch(error => console.error('Error updating timeframe:', error));
        }

        function updateSymbolPerformanceChart(symbolData) {
            if (!window.symbolChart || !symbolData) {
                console.warn('‚ùå Symbol chart not available or no symbol data');
                return;
            }
            
            const symbols = Object.keys(symbolData);
            const scores = symbols.map(symbol => {
                const data = symbolData[symbol];
                // Calculate performance score based on profit, win rate, and trade count
                const profitScore = Math.max(0, Math.min(100, (data.profit || 0) / 10 + 50));
                const winRateScore = data.win_rate || 0;
                const tradeCountScore = Math.min(100, (data.trade_count || 0) * 2);
                return (profitScore + winRateScore + tradeCountScore) / 3;
            });
            
            console.log('üìà Updating symbol performance chart:', { symbols, scores });
            
            window.symbolChart.data.labels = symbols;
            window.symbolChart.data.datasets[0].data = scores;
            window.symbolChart.update();
            
            console.log('üìà Symbol performance chart updated successfully');
        }

        // Fetch symbol performance data
        async function fetchSymbolPerformanceData() {
            try {
                const response = await fetchWithTimeout('/api/trades');
                const trades = await response.json();
                
                console.log('üìä Trade data received for symbol analysis:', trades);
                
                // Calculate symbol performance
                const symbolStats = {};
                trades.forEach(trade => {
                    const symbol = trade.symbol;
                    if (!symbolStats[symbol]) {
                        symbolStats[symbol] = {
                            profit: 0,
                            trade_count: 0,
                            wins: 0
                        };
                    }
                    symbolStats[symbol].profit += trade.profit || 0;
                    symbolStats[symbol].trade_count += 1;
                    if ((trade.profit || 0) > 0) {
                        symbolStats[symbol].wins += 1;
                    }
                });
                
                // Calculate win rates
                Object.keys(symbolStats).forEach(symbol => {
                    const stats = symbolStats[symbol];
                    stats.win_rate = stats.trade_count > 0 ? (stats.wins / stats.trade_count) * 100 : 0;
                });
                
                updateSymbolPerformanceChart(symbolStats);
                
            } catch (error) {
                console.error('‚ùå Error fetching symbol performance data:', error);
                showError('Failed to fetch symbol performance data');
                throw error;
            }
        }

        function updateEquityChart(periodOrHistoryData) {
            // Handle both period string and history data array
            if (typeof periodOrHistoryData === 'string') {
                console.log(`üìà Updating equity chart for period: ${periodOrHistoryData}`);
                
                // Map dropdown values to API timeframe values
                const timeframeMap = {
                    'daily': '1D',
                    'weekly': '1W', 
                    'monthly': '1M'
                };
                
                const apiTimeframe = timeframeMap[periodOrHistoryData] || '1M';
                console.log(`üìà Mapped period "${periodOrHistoryData}" to API timeframe "${apiTimeframe}"`);
                
                // Fetch new equity data for the selected timeframe
                fetchTradeHistory(apiTimeframe);
                return;
            }
            
            // Handle history data array
            const historyData = periodOrHistoryData;
            console.log('üìà Updating equity chart with history data:', historyData);
            
            if (!window.equityChart) {
                console.error('‚ùå Equity chart not available - chart not initialized');
                return;
            }
            
            if (!historyData || !Array.isArray(historyData) || !historyData.length) {
                console.warn('‚ùå No valid history data available for equity chart:', { 
                    exists: !!historyData, 
                    isArray: Array.isArray(historyData), 
                    length: historyData?.length 
                });
                // Set some dummy data to show chart structure
                window.equityChart.data.labels = ['No Data'];
                window.equityChart.data.datasets[0].data = [0];
                window.equityChart.update();
                return;
            }
            
            console.log('üìà Processing equity history data:', {
                length: historyData.length,
                firstPoint: historyData[0],
                lastPoint: historyData[historyData.length - 1]
            });
            
            // Extract labels and data with better error handling
            const labels = [];
            const data = [];
            
            historyData.forEach((point, index) => {
                try {
                    // Handle different timestamp formats
                    let timestamp = point.timestamp || point.time || point.date;
                    if (!timestamp) {
                        console.warn(`‚ö†Ô∏è Missing timestamp for point ${index}:`, point);
                        timestamp = new Date().toISOString(); // fallback
                    }
                    
                    const date = new Date(timestamp);
                    if (isNaN(date.getTime())) {
                        console.warn(`‚ö†Ô∏è Invalid timestamp for point ${index}:`, timestamp);
                        return; // skip this point
                    }
                    
                    const equity = point.equity || point.balance || point.value || 0;
                    if (typeof equity !== 'number' || isNaN(equity)) {
                        console.warn(`‚ö†Ô∏è Invalid equity value for point ${index}:`, equity);
                        return; // skip this point
                    }
                    
                    labels.push(date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: historyData.length > 50 ? undefined : '2-digit',
                        minute: historyData.length > 50 ? undefined : '2-digit'
                    }));
                    data.push(equity);
                } catch (error) {
                    console.error(`‚ùå Error processing point ${index}:`, error, point);
                }
            });
            
            console.log('üìà Processed equity chart data:', {
                labelsCount: labels.length,
                dataCount: data.length,
                labels: labels.slice(0, 5), // first 5 labels
                data: data.slice(0, 5), // first 5 data points
                dataRange: { min: Math.min(...data), max: Math.max(...data) }
            });
            
            if (labels.length === 0 || data.length === 0) {
                console.error('‚ùå No valid data points processed for equity chart');
                window.equityChart.data.labels = ['No Valid Data'];
                window.equityChart.data.datasets[0].data = [0];
                window.equityChart.update();
                return;
            }
            
            // Update chart data
            window.equityChart.data.labels = labels;
            window.equityChart.data.datasets[0].data = data;
            
            // Force chart update
            try {
                window.equityChart.update('active');
                console.log('‚úÖ Equity chart updated successfully with', data.length, 'data points');
            } catch (error) {
                console.error('‚ùå Error updating equity chart:', error);
                // Try to reinitialize the chart
                try {
                    window.equityChart.destroy();
                    initializeEquityChart();
                    window.equityChart.data.labels = labels;
                    window.equityChart.data.datasets[0].data = data;
                    window.equityChart.update();
                    console.log('‚úÖ Equity chart reinitialized and updated successfully');
                } catch (reinitError) {
                    console.error('‚ùå Failed to reinitialize equity chart:', reinitError);
                }
            }
        }
        
        // Add function to reinitialize equity chart if needed
        function initializeEquityChart() {
            const equityCtx = document.getElementById('equity-chart');
            if (!equityCtx) {
                console.error('‚ùå Equity chart canvas element not found');
                return;
            }
            
            window.equityChart = new Chart(equityCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Account Equity',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 1,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#f1f5f9',
                            borderColor: '#475569',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(100, 116, 139, 0.2)' },
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }
    </script>
</body>
</html> 